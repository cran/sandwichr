<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />


<meta name="date" content="2023-01-08" />

<title>A Tutorial for the sandwichr R Package</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">A Tutorial for the <code>sandwichr</code> R
Package</h1>
<h4 class="date">2023-01-08</h4>


<div id="TOC">
<ul>
<li><a href="#simulated-data">Simulated data</a>
<ul>
<li><a href="#loading-data">Loading data</a></li>
<li><a href="#calculating-morans-i">Calculating Moran’s
<em>I</em></a></li>
<li><a href="#selection-of-the-stratification-layers">Selection of the
stratification layer(s)</a></li>
<li><a href="#running-the-sandwich-mapping-model">Running the Sandwich
mapping model</a></li>
<li><a href="#model-validation">Model validation</a></li>
</ul></li>
<li><a href="#breast-cancer-incidence-in-mainland-china">Breast cancer
incidence in mainland China</a>
<ul>
<li><a href="#loading-data-1">Loading data</a></li>
<li><a href="#calculating-morans-i-1">Calculating Moran’s
<em>I</em></a></li>
<li><a href="#selection-of-the-stratification-layers-1">Selection of the
stratification layer(s)</a></li>
<li><a href="#running-the-sandwich-mapping-model-1">Running the Sandwich
mapping model</a></li>
<li><a href="#model-validation-1">Model validation</a></li>
</ul></li>
</ul>
</div>

<p>The <code>sandwichr</code> package performs spatial interpolation<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> based on
the spatial stratified heterogeneity (SSH) theory<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>. Three inputs are
required for this model: sampling, SSH, and reporting layers. By
utilizing the known distribution of the population in the SSH layer,
this model seeks to estimate the mean value of the sampling attribute
and its standard error for each reporting unit. The Sandwich model is
still applicable when the spatial dependence is weak because it does not
rely on the spatial dependence, provided that the geospatial surface is
properly stratified.</p>
<p>First, we need to install the <code>sandwichr</code> package from <a href="https://cran.r-project.org/">CRAN</a> (only do this once).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install the sandwichr package</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;sandwichr&quot;)</span></span></code></pre></div>
<p>Then use <code>library()</code> to load the installed package into
your environment. Remember to load the package every time you use
it.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Import the sandwichr package and other packages</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">&quot;sandwichr&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggpubr)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ape)</span></code></pre></div>
<p>Here,we present two case studies to demonstrate the functionality of
this package.</p>
<div id="simulated-data" class="section level2">
<h2>Simulated data</h2>
<p>In the first case study, interpolation is performed on a simulated
geospatial surface. The population data is organized as a 20*20 grid.
This population is divided into four continuous strata. We generate 41
sampling units at random within the grid. Based on the sample, we would
really like to infer the values of seven reporting units that make up
the surface. The sampling, SSH, and reporting layers are all in the
shapefile format.</p>
<div id="loading-data" class="section level3">
<h3>Loading data</h3>
<p>To successfully run the model, the <code>load.data.shp</code>
function is used to convert the shapefiles of sampling, stratification,
and reporting layers into a list of <code>sf</code> (simple feature; see
<a href="https://r-spatial.github.io/sf/index.html">Simple Features for
R</a> for references) objects for model input. You can specify the
directory and names for your input files. It should be noted that these
input files must be located in the same directory.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Input data from shapefiles</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>sim.sampling.name <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;sim.sampling.shp&quot;</span>, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">package=</span><span class="st">&quot;sandwichr&quot;</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>sim.ssh.name <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;sim.ssh.shp&quot;</span>, </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                           <span class="at">package=</span><span class="st">&quot;sandwichr&quot;</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>sim.reporting.name <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;sim.reporting.shp&quot;</span>, </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">package=</span><span class="st">&quot;sandwichr&quot;</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>sim.data <span class="ot">&lt;-</span> <span class="fu">load.data.shp</span>(<span class="at">sampling.file=</span>sim.sampling.name, </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">ssh.file=</span>sim.ssh.name,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                      <span class="at">reporting.file=</span>sim.reporting.name)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Sampling</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sim.data[[<span class="dv">1</span>]])</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 4 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 0.5549496 ymin: 2.956588 xmax: 3.99286 ymax: 5.2793
## Geodetic CRS:  WGS 84
## # A tibble: 6 x 5
##      id Value   Lon   Lat             geometry
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;          &lt;POINT [°]&gt;
## 1     0  401. 3.51   4.50  (3.506225 4.504105)
## 2     1  209. 1.48   2.96  (1.478404 2.956588)
## 3     2  412. 3.99   5.28     (3.99286 5.2793)
## 4     3  310. 0.666  3.15 (0.6659313 3.152236)
## 5     4  344. 2.39   3.70  (2.393734 3.699795)
## 6     5  111. 0.555  5.16 (0.5549496 5.161923)</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(sim.data[[<span class="dv">1</span>]])</span></code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(sim.data[[<span class="dv">1</span>]])</span></code></pre></div>
<pre><code>## $names
## [1] &quot;id&quot;       &quot;Value&quot;    &quot;Lon&quot;      &quot;Lat&quot;      &quot;geometry&quot;
## 
## $row.names
##  [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25
## [26] 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41
## 
## $class
## [1] &quot;sf&quot;         &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;
## 
## $sf_column
## [1] &quot;geometry&quot;
## 
## $agr
##    id Value   Lon   Lat 
##  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt;  &lt;NA&gt; 
## Levels: constant aggregate identity</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stratification</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sim.data[[<span class="dv">2</span>]])</span></code></pre></div>
<pre><code>## Simple feature collection with 4 features and 1 field
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 0 ymin: 2 xmax: 4 ymax: 6
## Geodetic CRS:  WGS 84
## # A tibble: 4 x 2
##       X                                                                 geometry
##   &lt;dbl&gt;                                                            &lt;POLYGON [°]&gt;
## 1     1 ((0.2 5, 0 5, 0 5.2, 0 5.4, 0 5.6, 0 5.8, 0 6, 0.2 6, 0.4 6, 0.6 6, 0.8~
## 2     3 ((0.8 3.8, 0.8 3.6, 1 3.6, 1.2 3.6, 1.4 3.6, 1.4 3.4, 1.4 3.2, 1.4 3, 1~
## 3     2 ((3.8 3.6, 3.8 3.4, 3.8 3.2, 3.8 3, 3.6 3, 3.4 3, 3.2 3, 3 3, 2.8 3, 2.~
## 4     4 ((4 2.8, 4 2.6, 4 2.4, 4 2.2, 4 2, 3.8 2, 3.6 2, 3.4 2, 3.2 2, 3 2, 2.8~</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(sim.data[[<span class="dv">2</span>]])</span></code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(sim.data[[<span class="dv">2</span>]])</span></code></pre></div>
<pre><code>## $names
## [1] &quot;X&quot;        &quot;geometry&quot;
## 
## $row.names
## [1] 1 2 3 4
## 
## $class
## [1] &quot;sf&quot;         &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;
## 
## $sf_column
## [1] &quot;geometry&quot;
## 
## $agr
##    X 
## &lt;NA&gt; 
## Levels: constant aggregate identity</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reporting</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sim.data[[<span class="dv">3</span>]])</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 1 field
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 5.684342e-14 ymin: 2 xmax: 4 ymax: 6
## Geodetic CRS:  WGS 84
## # A tibble: 6 x 2
##       Y                                                                 geometry
##   &lt;dbl&gt;                                                            &lt;POLYGON [°]&gt;
## 1     1 ((0.6 4, 0.6 5, 0.8 5, 1 5, 1.2 5, 1.4 5, 1.6 5, 1.8 5, 2 5, 2 4.8, 2 4~
## 2     3 ((1 3.4, 1 3.2, 1 3, 1.2 3, 1.4 3, 1.6 3, 1.6 2.8, 1.8 2.8, 2 2.8, 2.2 ~
## 3     2 ((2.4 3.6, 1.6 3.6, 1.6 3.8, 1.6 4, 1.8 4, 2 4, 2 4.2, 2 4.4, 2 4.6, 2 ~
## 4     4 ((4 3.8, 4 3.6, 4 3.4, 4 3.2, 3.8 3.2, 3.8 3, 3.8 2.8, 3.6 2.8, 3.6 3, ~
## 5     5 ((1 3.4, 1 4, 1.2 4, 1.4 4, 1.6 4, 1.6 3.8, 1.6 3.6, 1.6 3.4, 1.4 3.4, ~
## 6     6 ((1.6 3.6, 2.4 3.6, 2.4 3.4, 2.4 3.2, 2.4 3, 2.4 2.8, 2.2 2.8, 2 2.8, 1~</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(sim.data[[<span class="dv">3</span>]])</span></code></pre></div>
<pre><code>## [1] &quot;sf&quot;         &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">attributes</span>(sim.data[[<span class="dv">3</span>]])</span></code></pre></div>
<pre><code>## $names
## [1] &quot;Y&quot;        &quot;geometry&quot;
## 
## $row.names
## [1] 1 2 3 4 5 6 7
## 
## $class
## [1] &quot;sf&quot;         &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;
## 
## $sf_column
## [1] &quot;geometry&quot;
## 
## $agr
##    Y 
## &lt;NA&gt; 
## Levels: constant aggregate identity</code></pre>
</div>
<div id="calculating-morans-i" class="section level3">
<h3>Calculating Moran’s <em>I</em></h3>
<p>We use the Moran’s <em>I</em> to evaluate the spatial dependence of
the simulated data.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>sim.dists <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">cbind</span>(sim.data[[<span class="dv">1</span>]]<span class="sc">$</span>Lon, sim.data[[<span class="dv">1</span>]]<span class="sc">$</span>Lat)))</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>sim.dists.inv <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>sim.dists</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(sim.dists.inv) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="fu">Moran.I</span>(sim.data[[<span class="dv">1</span>]]<span class="sc">$</span>Value, sim.dists.inv)</span></code></pre></div>
<pre><code>## $observed
## [1] 0.234028
## 
## $expected
## [1] -0.025
## 
## $sd
## [1] 0.03428651
## 
## $p.value
## [1] 4.196643e-14</code></pre>
</div>
<div id="selection-of-the-stratification-layers" class="section level3">
<h3>Selection of the stratification layer(s)</h3>
<p>The accuracy of SSH-based spatial interpolation is determined by the
stratification layer. In an ideal stratification layer, values of the
target attribute are expected to be homogeneous within each stratum and
to differ between the strata. To determine a proper stratification layer
for the Sandwich model, the geographical detector model<a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a> is applied to quantify
the SSH of the target attribute with regard to the candidate
stratification(s).</p>
<p>First, we combine the sampling and candidate stratification layers
into a single data frame.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the stratification layer(s) for evaluation</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>sim.join <span class="ot">&lt;-</span> <span class="fu">ssh.data.shp</span>(<span class="at">object=</span>sim.data[[<span class="dv">1</span>]], <span class="at">ssh.lyr=</span>sim.data[[<span class="dv">2</span>]], <span class="at">ssh.id=</span><span class="st">&quot;X&quot;</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sim.join)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 5 fields
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 0.5549496 ymin: 2.956588 xmax: 3.99286 ymax: 5.2793
## Geodetic CRS:  WGS 84
## # A tibble: 6 x 6
##      id Value   Lon   Lat             geometry     X
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;          &lt;POINT [°]&gt; &lt;dbl&gt;
## 1     0  401. 3.51   4.50  (3.506225 4.504105)     2
## 2     1  209. 1.48   2.96  (1.478404 2.956588)     4
## 3     2  412. 3.99   5.28     (3.99286 5.2793)     2
## 4     3  310. 0.666  3.15 (0.6659313 3.152236)     3
## 5     4  344. 2.39   3.70  (2.393734 3.699795)     2
## 6     5  111. 0.555  5.16 (0.5549496 5.161923)     1</code></pre>
<p>The factor detector <em>q</em>-statistic in the geographical detector
model is applied through the <code>ssh.test</code> function to measure
the SSH of the sampling data in terms of different stratifications. This
function takes a data frame generated by the <code>ssh.data.shp</code>
(or <code>ssh.data.txt</code>, which will be introduced later) function
(argument <code>object</code>), where the sampling attribute (argument
<code>y</code>) and the strata ID(s) (argument <code>x</code>) must be
specified. In this example, the output of <code>ssh.test</code>
(<em>q</em> = .81) implies that the candidate stratification layer has a
high determinant power over the attribute. Therefore, it will be
reasonable to select the stratification layer for subsequent
interpolation.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the geographical detector q-statistic</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh.test</span>(<span class="at">object=</span>sim.join, <span class="at">y=</span><span class="st">&quot;Value&quot;</span>, <span class="at">x=</span><span class="fu">c</span>(<span class="st">&quot;X&quot;</span>), <span class="at">test=</span><span class="st">&quot;factor&quot;</span>)</span></code></pre></div>
<pre><code>## [[1]]
##   q-statistic      p-value
## X   0.9212376 3.764869e-10</code></pre>
<p>We can visualize the mean and standard deviation of the sample in
each stratum.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggerrorplot</span>(sim.join, <span class="at">x =</span> <span class="st">&quot;X&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Value&quot;</span>, </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">desc_stat =</span> <span class="st">&quot;mean_sd&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">add =</span> <span class="st">&quot;violin&quot;</span>, <span class="at">add.params =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">&quot;darkgray&quot;</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>())</span></code></pre></div>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASAAAAEgCAMAAAAjXV6yAAAATlBMVEUAAAAAADoAAGYAOpAAZrY6AAA6ADo6AGY6Ojo6kNtmAABmADpmtv+QOgCQZgCQ2/+pqam2ZgC2///bkDrb////tmb/25D//7b//9v///9pTXSCAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAJq0lEQVR4nO2di3ajOAyGs5Nud9Ntp2QoTXn/F13MLTbGlmTwXf85bWiCCPpqGxtL+NKzrLrEPoHUxYAAMSBADAgQAwLEgAAdBFQ+XwYEiAEBYkCAGBAgBgSIAQFiQIAYECAGBIgBAWJAgNID1Jx/yCNiQICsHj7eLoNehq3ucvnrs5c3EOZuygnQ9+vMohugiJ/nBsbcTTkB6n79GV9/Pm7D7/vLcwNl7qQmJ0DtTOL773fx168/6wbK3ElZAbr/OzRBt6WqDeVp3RhNhU4/oZwAPd6uXwOl29zqDL/XDYy5m3ICNGkoLwzIpqHd2a9iOHOqMgT0+hm2kU6LkM3DCcdQXgJe5gc8+QCaSAyNdMCOYpNaT9Hu4X24kItS1LfLCKP1PNRoXFohn7UyscFqs/4iWdUGiOpvPYAa5QVvVgugxVGqw/UA0jaQdpUAkvykeVwNIGmT5HIlgBrjH6BlFYBUL0k+VwLI+qfdtAZAWycpTtcBCHzDYlsnILzXNQDa8ZEByXq6eNHfAo0ZEGBcKSC025UCwhehCgBJHtIBNT5nQooA5PNGPwMClDIgrNsVAJL9Y0A7YkCATIBwfpcPSHHvYvrAZs6AAPOKAClRfbg6VjwgCcNlE/jIgITkThAD2tG2AF2InenyAa3u5QjoLkKBPedqGNugDBrp7iIAeQ7BMwPCmkcD9HgTgHwHcTZKMy1/gDOPCKi9/h4AeQ8DznYs9v36Kdog74HkShHafddqHQ2QqFEC0H4qwpnJLJneMGsHOGZAoDlFR2Y1ogEaK1SQKqb0hda30LaxALVzt+09RK6GBogwbxi9oxgkV2PxcT4kJXYhOqAguRoLkQUQwTI+oCC5GgogUvxU6YPVWTOTGRDF0Ofkc0KAegkQOQCvOkBUszoANeshGdCuGm0DbcWAAKtKAC1ukmpYQzahKClAi5e0PATl5XSlCci3DUHZA3LNUsQqf0DLaTAgi0k9gMhXpGfn0lMdSwtQTwf0PA0GZDYgD3DxSgsQuYqp95DOPRn50LHMtyI30gwIZ8CA7Ps73MdGiwEBYkCAsgZ0YLIRLQYEiAEBSgsQrSetBzx46EynCIgQOLU9jUoAUXZWT4MBaTurp1E+IMo08rMJqgcQJRBhjZeRgiXPb6VTBITfdToHOZqUASm7jqeg5HeUDwj/uOQUALVaDov3hUfIgGJWMRHOqoYm+l94BP8cjhiAxtwV8YTt+a+biLZ/SXThEakbRI/OR0vxcCgb7fVr5LJKAEpz4RFpx0CARPkQ2QcSgIHGUKHSXHgkPKDH2/sISEo16MaVWdJcVyNeCZpCo9c3r18MaNbUBrXTc/6lN9NceCQCoGnFNbmf008rswRspOl37PuAgFTFWHjEYdZQPo3Ao/k10yfNFeqCA5qWNBy0VqHwC48kDWhWJ3eD6ObhFO2mvdTGuJiHU6xpH0IRqhNQmw2g7dx8GECPt1yqWOjgheUqJo80COYRVF10B1m1RZiRxYAAyYnAfpa7WT1cu9FyTxpvHkvN7ibGkArITfEBNfoW0dCu3AE9yw2VjwugpZplVMWcAWGLkOLh/frVLnMYOOUKqEEHSagdxVvfiVkNfE8xPiCXHLOZjQOg9/77nz/jD1J5AqKkcW5nNR7/fRYPiHTlUzwUw/j7rfQqJlOBCake3l/ElSyXO4qTGlJk7Pb6Dl7us+8HUQM/tR0BQtJQA39x3zGPKAqgPRp2QspYDH+jTDOPKAKgfRZWQpKHPx/arCqovACZSNgI6VPPN8OeCPM4IgAif7DjYUcZitUIqM9o2meSG6CL6YON9kpQPjftR6EBNccBld0GKfuogMzmFV3FGjMgi3kB/SBsAoy6ywaQ0b6AnjQuv2ODYBufayRUwFgMBWhTv/QQZtOo1eqhaJWmRjtcroaDYEBb73cAmQqRzcOfj4FFK1qmkCF4dIGAtq5rK+QY9hv3tRx3jWkNGsRJFwBIrzwmQHv1DPZQxEmHDAOmyw5ot1gY0yh0mODX36X48QCB5A6yAtptWcyA9OoIfXs3tNL+Fx45JBsg49XbeObb9hz48m5po0PlarjIfGMZ0QHUbZD7jerGq3ziVcyCwTegduoFJd5I2wYa9B4ypYoteT+JX+atIzFiD1nb3d4PWm59pN1RBIaq+DRhaj9oXttH8AiYq+EgiECDYrS/VwmDVczNDgiRkWEtgHp7Z8DlaodSToB6AyN74aoLkE4DbJ5qA6TujWi8KwTkHmHmoDwBUWKK6gTkGOXqoFwBIfuOfb2A6klFEMoXkMOJu4gBAfK1ro9QEYB8yisgn//ZUGJAgDwDyp+QX0AFNEI+AaHidlKXR0CkZ0MnK3+AiFk4qcobIMo9l5TlC5Cc1Zc1Ij+AVChZE/ICaEsk50LkARB9aiVlnQ7IhCJXQmcDcolESVrnArLXpCwJnQoIChHNkdC5gKCjZ0joTEC693oTdezrIogBAYIAzQ86QSWz1Ajo8TZGtOJiFCsENOeII6NcERGQhQHqLrcxaBwbJ61n1WyPWBigfo6qxy48AmetFQoIm6vBgOyA9vJCrWUsBx2oYpr5XgHSUmcPnW0E4QDhGundzNDN8coEhLvM76fObo5XJiBcR3Gnn7hzP83tNOMJBwiVzLLTvlQAiGKO6UlXDQjOqc6Pz+m3XG0fZ4jH9017tYnKkY/naZ+L/P6xb4olLxOHjfZxrnh46hmUp+gODl6AzJWstWPfEVf+AqjWjaz5+I8wy29wocpjjOL8woAMapSXbMUlCJB3QLkXIQYEiK9igAL0g459Q2wxIEBcxQBxIw2I+0GAfKdD5V6AvCbUjb8YkFGccQiZox9Bk7K8AuKsZ04LP2ae82zGIs+Ajh09BTEgQAwIEBUQbeGR+gARnyddHaBEn0juUzQPE32mvU8RAaW5KoJP0TxMc+ERrzoAiG6eo7iKAeJGGhBf5gH57SgWIKqHSS484lNeB6sl6CigYnUSIIhfujZYEwZ0/qE9nEUEmzQAFSAGBIgBAWJAgBgQIAYEyCug+fleeD0XuCdoMzxE6n79Qu3nE9D8fC+8ngvcEyTuTnVkQt0lPqD5+V4EaffjEHq83QRZGtTBKj6g5fledEN6hSEDaq+/owPqlZvXBN3pVi2R6ffrZwptkBugjtxKd9SGXdw5zhZQR2yjR/18IN2d1A575wqIXn4mM0odGyevMgXUuvGZr3/oL5mEMkkLUIs7aVkTGvq/IssS9FzgniDh6TRfRzbDKClA0gL3BN2xtUW1SgFQCWJAgBgQIAYEiAEBYkCAGBAgBgSIAQFiQID+B7dO7uu+3cH5AAAAAElFTkSuQmCC" /></p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>sim.join <span class="sc">%&gt;%</span>                                        </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(X) <span class="sc">%&gt;%</span>                         </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_at</span>(<span class="fu">vars</span>(Value),              </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>               <span class="fu">list</span>(<span class="at">name =</span> mean))</span></code></pre></div>
<pre><code>## Simple feature collection with 4 features and 2 fields
## Geometry type: MULTIPOINT
## Dimension:     XY
## Bounding box:  xmin: 0.05899652 ymin: 2.041932 xmax: 3.99286 ymax: 5.921005
## Geodetic CRS:  WGS 84
## # A tibble: 4 x 3
##       X  name                                                           geometry
##   &lt;dbl&gt; &lt;dbl&gt;                                                   &lt;MULTIPOINT [°]&gt;
## 1     1  93.8 ((0.4581337 5.024432), (0.5549496 5.161923), (0.4016744 5.921005)~
## 2     2 413.  ((2.92014 3.070043), (2.744322 3.482087), (3.207056 3.377478), (3~
## 3     3 312.  ((0.4727599 2.430498), (0.4892411 2.141553), (1.774888 2.379797),~
## 4     4 207.  ((3.783199 2.041932), (3.495714 2.111997), (3.113503 2.943583), (~</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>sim.join <span class="sc">%&gt;%</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(X) <span class="sc">%&gt;%</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean=</span><span class="fu">mean</span>(Value), <span class="at">sd=</span><span class="fu">sd</span>(Value), <span class="at">n=</span><span class="fu">n</span>())</span></code></pre></div>
<pre><code>## Simple feature collection with 4 features and 4 fields
## Geometry type: MULTIPOINT
## Dimension:     XY
## Bounding box:  xmin: 0.05899652 ymin: 2.041932 xmax: 3.99286 ymax: 5.921005
## Geodetic CRS:  WGS 84
## # A tibble: 4 x 5
##       X  mean    sd     n                                               geometry
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;                                       &lt;MULTIPOINT [°]&gt;
## 1     1  93.8  24.4     9 ((0.4581337 5.024432), (0.5549496 5.161923), (0.40167~
## 2     2 413.   38.7    17 ((2.92014 3.070043), (2.744322 3.482087), (3.207056 3~
## 3     3 312.   49.5    11 ((0.4727599 2.430498), (0.4892411 2.141553), (1.77488~
## 4     4 207.   18.8     4 ((3.783199 2.041932), (3.495714 2.111997), (3.113503 ~</code></pre>
</div>
<div id="running-the-sandwich-mapping-model" class="section level3">
<h3>Running the Sandwich mapping model</h3>
<p>The Sandwich mapping model is performed using the
<code>sandwich.model</code> function, which returns the mean value of
the sampling attribute and its standard error for each reporting
unit.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform the SSH based spatial interpolation</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>sim.sw <span class="ot">&lt;-</span> <span class="fu">sandwich.model</span>(<span class="at">object=</span>sim.data, <span class="at">sampling.attr=</span><span class="st">&quot;Value&quot;</span>, <span class="at">type=</span><span class="st">&quot;shp&quot;</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(sim.sw<span class="sc">$</span>object)</span></code></pre></div>
<pre><code>## Simple feature collection with 6 features and 4 fields
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: 5.684342e-14 ymin: 2 xmax: 4 ymax: 6
## Geodetic CRS:  WGS 84
## # A tibble: 6 x 5
##       Y                                               geometry  mean    se    df
##   &lt;dbl&gt;                                          &lt;POLYGON [°]&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     1 ((0.6 4, 0.6 5, 0.8 5, 1 5, 1.2 5, 1.4 5, 1.6 5, 1.8 ~  381.  2.61    34
## 2     3 ((1 3.4, 1 3.2, 1 3, 1.2 3, 1.4 3, 1.6 3, 1.6 2.8, 1.~  298.  3.05    29
## 3     2 ((2.4 3.6, 1.6 3.6, 1.6 3.8, 1.6 4, 1.8 4, 2 4, 2 4.2~  262.  2.27    24
## 4     4 ((4 3.8, 4 3.6, 4 3.4, 4 3.2, 3.8 3.2, 3.8 3, 3.8 2.8~  401.  3.02    19
## 5     5 ((1 3.4, 1 4, 1.2 4, 1.4 4, 1.6 4, 1.6 3.8, 1.6 3.6, ~  390.  2.74    26
## 6     6 ((1.6 3.6, 2.4 3.6, 2.4 3.4, 2.4 3.2, 2.4 3, 2.4 2.8,~  357.  3.02    29</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(sim.sw)</span></code></pre></div>
<pre><code>## [1] &quot;Sample size:  41&quot;
## [1] &quot;Number of SSH strata:  4&quot;
## [1] &quot;Number of reporting units:  7&quot;</code></pre>
<pre><code>##       mean             se                 geometry
##  Min.   :202.8   Min.   :1.668   POLYGON      :7  
##  1st Qu.:280.0   1st Qu.:2.435   epsg:4326    :0  
##  Median :357.1   Median :2.742   +proj=long...:0  
##  Mean   :327.4   Mean   :2.625                    
##  3rd Qu.:385.8   3rd Qu.:3.022                    
##  Max.   :400.6   Max.   :3.050</code></pre>
<p>The interpolated values and standard errors can be visualized using
<code>plot.mean</code> and <code>plot.se()</code>.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the estimated mean values and standard errors</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">autoplot</span>(<span class="at">object=</span>sim.sw)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="data:image/png;base64,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" alt=" " />
<p class="caption">
</p>
</div>
</div>
<div id="model-validation" class="section level3">
<h3>Model validation</h3>
<p>To evaluate the overall accuracy of the Sandwich mapping model, a
stratified <em>k</em>-fold cross validation is performed using the
<code>sandwich.cv</code> function. A diagnostic statistic called
cross-validation estimate (CVE) will be calculated. Here, we present the
result of a stratified 5-fold cross validation.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform k-fold cross validation</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>sim.cv <span class="ot">&lt;-</span> <span class="fu">sandwich.cv</span>(<span class="at">object=</span>sim.data, <span class="at">sampling.attr=</span><span class="st">&quot;Value&quot;</span>, <span class="at">k=</span><span class="dv">5</span>, <span class="at">type=</span><span class="st">&quot;shp&quot;</span>, <span class="at">ssh.id.col=</span><span class="st">&quot;X&quot;</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>sim.cv</span></code></pre></div>
<pre><code>## [1] 110.4208</code></pre>
</div>
</div>
<div id="breast-cancer-incidence-in-mainland-china" class="section level2">
<h2>Breast cancer incidence in mainland China</h2>
<p>The second case study interpolates the breast cancer incidence across
mainland China based on 242 samples retrieved from the Chinese Cancer
Registry Annual Report. The urban-rural classification (either urban or
rural areas are typically not connected in space) is used as the
stratification layer. County-level divisions are used as the reporting
units. In this example, all the input data are in csv format.</p>
<div id="loading-data-1" class="section level3">
<h3>Loading data</h3>
<p>The <code>load.data.txt</code> function is used to prepare text files
into a list of data frames for model input. Two files are needed for
this function: one linking sampling and stratification layers, and the
other linking reporting and stratification layers.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Input data from text files</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>bc.sampling_ssh.name <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;bc_sampling_ssh.csv&quot;</span>, </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">package=</span><span class="st">&quot;sandwichr&quot;</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>bc.reporting_ssh.name <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;bc_reporting_ssh.csv&quot;</span>, </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">package=</span><span class="st">&quot;sandwichr&quot;</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>bc.data <span class="ot">&lt;-</span> <span class="fu">load.data.txt</span>(<span class="at">sampling_ssh.file=</span>bc.sampling_ssh.name, </span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>                         <span class="at">reporting_ssh.file=</span>bc.reporting_ssh.name)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Sampling-stratification</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(bc.data[[<span class="dv">1</span>]])    </span></code></pre></div>
<pre><code>##   GBCODE Incidence SSHID        X        Y
## 1 110100        42     1 115.9642 39.86494
## 2 120100        44     1 117.3913 39.01184
## 3 120225        26     2 117.4309 40.00251
## 4 130129         9     2 114.2797 37.61767
## 5 130181        36     1 115.2870 37.91756
## 6 130227        20     2 118.3576 40.23177</code></pre>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(bc.data[[<span class="dv">1</span>]])</span></code></pre></div>
<pre><code>## [1] &quot;data.frame&quot;</code></pre>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Reporting-stratification</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(bc.data[[<span class="dv">2</span>]])    </span></code></pre></div>
<pre><code>##   GBCODE        W1        W2
## 1 110100 0.8736000 0.1264000
## 2 110112 0.6115000 0.3885000
## 3 110113 0.5378000 0.4622000
## 4 110221 0.5245597 0.4754403
## 5 110224 0.5245597 0.4754403
## 6 110226 0.5245597 0.4754403</code></pre>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(bc.data[[<span class="dv">2</span>]])</span></code></pre></div>
<pre><code>## [1] &quot;data.frame&quot;</code></pre>
</div>
<div id="calculating-morans-i-1" class="section level3">
<h3>Calculating Moran’s <em>I</em></h3>
<p>We use the Moran’s <em>I</em> to evaluate the SAC of the breast
cancer incidence.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>bc.dists <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(<span class="fu">cbind</span>(bc.data[[<span class="dv">1</span>]]<span class="sc">$</span>X, bc.data[[<span class="dv">1</span>]]<span class="sc">$</span>Y)))</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>bc.dists.inv <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>bc.dists</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(bc.dists.inv) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="fu">Moran.I</span>(bc.data[[<span class="dv">1</span>]]<span class="sc">$</span>Incidence, bc.dists.inv)</span></code></pre></div>
<pre><code>## $observed
## [1] 0.04940197
## 
## $expected
## [1] -0.004149378
## 
## $sd
## [1] 0.008379477
## 
## $p.value
## [1] 1.650469e-10</code></pre>
</div>
<div id="selection-of-the-stratification-layers-1" class="section level3">
<h3>Selection of the stratification layer(s)</h3>
<p>First, we use the <code>ssh.data.txt</code> function to convert the
input data for evaluation.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare the stratification layer for evaluation</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>bc.join <span class="ot">&lt;-</span> <span class="fu">ssh.data.txt</span>(<span class="at">object=</span>bc.data)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(bc.join)</span></code></pre></div>
<pre><code>##   GBCODE Incidence SSHID        X        Y
## 1 110100        42     1 115.9642 39.86494
## 2 120100        44     1 117.3913 39.01184
## 3 120225        26     2 117.4309 40.00251
## 4 130129         9     2 114.2797 37.61767
## 5 130181        36     1 115.2870 37.91756
## 6 130227        20     2 118.3576 40.23177</code></pre>
<p>The factor detector <em>q</em>-statistic in the geographical detector
model is applied through the <code>ssh.test</code> function to measure
the SSH of the sample regarding the urban-rural classification. In this
example, the output of <code>ssh.test</code> implies a relatively high
level of SSH in the distribution of breast cancer incidence concerning
the given stratification (<em>q</em> = .52). Therefore, it is reasonable
to select the urban-rural classification as the stratification layer for
subsequent interpolation.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the geographical detector q-statistic</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh.test</span>(<span class="at">object=</span>bc.join, <span class="at">y=</span><span class="st">&quot;Incidence&quot;</span>, <span class="at">x=</span><span class="st">&quot;SSHID&quot;</span>, <span class="at">test=</span><span class="st">&quot;factor&quot;</span>, <span class="at">type=</span><span class="st">&quot;txt&quot;</span>)</span></code></pre></div>
<pre><code>## [[1]]
##       q-statistic      p-value
## SSHID   0.5165114 7.219864e-11</code></pre>
<p>We can visualize the mean and standard deviation of the sampled
breast cancer incidence in each stratum.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">=</span> <span class="fu">ggerrorplot</span>(bc.data[[<span class="dv">1</span>]], <span class="at">x =</span> <span class="st">&quot;SSHID&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Incidence&quot;</span>, </span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">desc_stat =</span> <span class="st">&quot;mean_sd&quot;</span>, <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">add =</span> <span class="st">&quot;violin&quot;</span>, <span class="at">add.params =</span> <span class="fu">list</span>(<span class="at">color =</span> <span class="st">&quot;darkgray&quot;</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>p <span class="sc">+</span> <span class="fu">scale_x_discrete</span>(<span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Urban&quot;</span>, <span class="st">&quot;2&quot;</span> <span class="ot">=</span> <span class="st">&quot;Rural&quot;</span>)) <span class="sc">+</span> </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.title.x =</span> <span class="fu">element_blank</span>()) <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">y=</span><span class="st">&quot;Breast Cancer Incidence (Rate per 100,000)&quot;</span>)</span></code></pre></div>
<p><img src="data:image/png;base64,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" /></p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>bc.data[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span>                                        </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(SSHID) <span class="sc">%&gt;%</span>                         </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise_at</span>(<span class="fu">vars</span>(Incidence),              </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>               <span class="fu">list</span>(<span class="at">name =</span> mean))</span></code></pre></div>
<pre><code>## # A tibble: 2 x 2
##   SSHID  name
##   &lt;int&gt; &lt;dbl&gt;
## 1     1  31.6
## 2     2  17.5</code></pre>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>bc.data[[<span class="dv">1</span>]] <span class="sc">%&gt;%</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(SSHID) <span class="sc">%&gt;%</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean=</span><span class="fu">mean</span>(Incidence), <span class="at">sd=</span><span class="fu">sd</span>(Incidence), <span class="at">n=</span><span class="fu">n</span>())</span></code></pre></div>
<pre><code>## # A tibble: 2 x 4
##   SSHID  mean    sd     n
##   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
## 1     1  31.6  8.07   125
## 2     2  17.5  5.12   117</code></pre>
</div>
<div id="running-the-sandwich-mapping-model-1" class="section level3">
<h3>Running the Sandwich mapping model</h3>
<p>The Sandwich mapping model is performed using the
<code>sandwich.model</code> function, which outputs the mean value of
the sampling attribute and its standard error for each reporting
unit.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform the SSH based spatial interpolation</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>bc.sw <span class="ot">&lt;-</span> <span class="fu">sandwich.model</span>(<span class="at">object=</span>bc.data, <span class="at">sampling.attr=</span><span class="st">&quot;Incidence&quot;</span>, <span class="at">type=</span><span class="st">&quot;txt&quot;</span>, </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">ssh.id.col=</span><span class="st">&quot;SSHID&quot;</span>, <span class="at">ssh.weights=</span><span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="fu">c</span>(<span class="st">&quot;W1&quot;</span>,<span class="st">&quot;W2&quot;</span>)))</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(bc.sw<span class="sc">$</span>object)</span></code></pre></div>
<pre><code>##   GBCODE        W1        W2     mean        se  df
## 1 110100 0.8736000 0.1264000 29.78768 0.7965111 240
## 2 110112 0.6115000 0.3885000 26.11263 0.6894776 240
## 3 110113 0.5378000 0.4622000 25.07924 0.6604525 240
## 4 110221 0.5245597 0.4754403 24.89360 0.6552986 240
## 5 110224 0.5245597 0.4754403 24.89360 0.6552986 240
## 6 110226 0.5245597 0.4754403 24.89360 0.6552986 240</code></pre>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bc.sw)</span></code></pre></div>
<pre><code>## [1] &quot;Sample size:  242&quot;
## [1] &quot;Number of SSH strata:  2&quot;
## [1] &quot;Number of reporting units:  2352&quot;</code></pre>
<pre><code>##       mean             se        
##  Min.   :17.54   Min.   :0.4732  
##  1st Qu.:21.22   1st Qu.:0.5579  
##  Median :22.38   Median :0.5876  
##  Mean   :22.73   Mean   :0.5986  
##  3rd Qu.:23.86   3rd Qu.:0.6270  
##  Max.   :31.56   Max.   :0.8498</code></pre>
</div>
<div id="model-validation-1" class="section level3">
<h3>Model validation</h3>
<p>To evaluate the overall accuracy of SSH-based spatial interpolation,
a <em>k</em>-fold cross validation can be performed using the
<code>sandwich.cv</code> function. A diagnostic statistic called root
mean square error (RMSE) will be calculated. Here, we present the result
of a 5-fold cross validation.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform k-fold cross validation</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>bc.cv <span class="ot">&lt;-</span> <span class="fu">sandwich.cv</span>(<span class="at">object=</span>bc.data, <span class="at">sampling.attr=</span><span class="st">&quot;Incidence&quot;</span>, <span class="at">k=</span><span class="dv">5</span>, <span class="at">type=</span><span class="st">&quot;txt&quot;</span>, </span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ssh.id.col=</span><span class="st">&quot;SSHID&quot;</span>, <span class="at">reporting.id.col=</span><span class="st">&quot;GBCODE&quot;</span>, </span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">ssh.weights=</span><span class="fu">list</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>), <span class="fu">c</span>(<span class="st">&quot;W1&quot;</span>,<span class="st">&quot;W2&quot;</span>)))</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>bc.cv</span></code></pre></div>
<pre><code>## [1] 8.680166</code></pre>
</div>
</div>
<div class="footnotes footnotes-end-of-document">
<hr />
<ol>
<li id="fn1"><p>Wang, J. F., Haining, R., Liu, T. J., Li, L. F., &amp;
Jiang, C. S. (2013). Sandwich estimation for multi-unit reporting on a
stratified heterogeneous surface. <em>Environment and Planning A</em>,
45(10), 2515-2534.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Wang, J. F., Haining, R., Liu, T. J., Li, L. F., &amp;
Jiang, C. S. (2013). Sandwich estimation for multi-unit reporting on a
stratified heterogeneous surface. <em>Environment and Planning A</em>,
45(10), 2515-2534.<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>Wang, J. F., Li, X. H., Christakos, G., Liao, Y. L.,
Zhang, T., Gu, X., &amp; Zheng, X. Y. (2010). Geographical
detectors-based health risk assessment and its application in the neural
tube defects study of the Heshun Region, China. <em>International
Journal of Geographical Information Science</em>, 24(1), 107-127.<a href="#fnref3" class="footnote-back">↩︎</a></p></li>
</ol>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
